/\* \* Copyright (c) Facebook, Inc. and its affiliates. \* \* Licensed
under the Apache License, Version 2.0 (the \"License\"); \* you may not
use this file except in compliance with the License. \* You may obtain a
copy of the License at \* \* http://www.apache.org/licenses/LICENSE-2.0
\* \* Unless required by applicable law or agreed to in writing,
software \* distributed under the License is distributed on an \"AS IS\"
BASIS, \* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
or implied. \* See the License for the specific language governing
permissions and \* limitations under the License. \*/ {namespace
cxx_genrule} /\*\*\*/ {template .soyweb} {call buck.page} {param title:
\'cxx_genrule()\' /} {param navid: \'rule_cxx_genrule\' /} {param
prettify: true /} {param description} A rule that is used to
post-process a C or C++ executable or library. {/param} {param content}
{call buck.rule} {param status: \'FROZEN\' /} {param overview}

A `cxx_genrule()` enables you to run shell commands as part of the Buck
build process. A `cxx_genrule()` exposes---through a set of string
parameter macros and variables---information about the tools and
configuration options used by the Buck environment, specifically those
related to the C/C++ toolchain.

The information exposed through these tools and configuration options is
a reflection of: Buck\'s built-in settings, the settings in {call
buck.buckconfig_link /} and `.buckconfig.local`, and the result of
various command-line overrides specified through the {sp}{call
buck.cmd_link}{param name: \'common_parameters\' /}{param rendered_text:
\'`--config`\' /}{/call} command-line option.

This information is available only to the shell commands specified in
the `cxx_genrule`. The information is not available to other arguments
of the rule.

A {sp}`cxx_genrule()` can be an input to another {sp}`cxx_genrule()`.

Note that if you specify the `cxx_genrule` as a command-line target to
`buck build`, you must include a platform flavor. For example:

    {literal}
    buck build :cxx_gr_name#iphonesimulator-x86_64
    {/literal}

You could also just specify the default platform flavor explicitly:

    {literal}
    buck build :cxx_gr_name#default
    {/literal}

{/param} {param args} {call buck.name_arg /} {call
genrule_common.srcs_arg /} {call buck.arg} {param name: \'cmd\' /}
{param default: \'None\' /} {param desc} The shell command to run to
generate the output file. It is the fallback of `bash` {sp}and
`cmd_exe`. The shell command can access information about the buck build
environment through a set of *macros*, *parameterized macros*, and
*variables*.

#### Macros

The following macros are available to the shell command and are accessed
using the following syntax.

    $(<macro>)

Example:

    $(cc)

`$(cc)`
:   Path to the C compiler.

`$(cxx)`
:   Path to the C++ compiler.

`$(cflags)`
:   Flags passed to the C compiler.

`$(cppflags)`
:   Flags passed to the C preprocessor.

`$(cxxflags)`
:   Flags passed to the C++ compiler.

`$(ld)`
:   Path to the linker.

`$(ldflags-pic)`
:   Flags passed to the linker for binaries that use
    position-independent code (PIC).

`$(ldflags-pic-filter <pattern>)`
:   Flags passed to the linker for binaries that use
    position-independent code (PIC). Use the *pattern* parameter to
    specify a regular expression that matches the build targets that use
    these flags.

`$(ldflags-shared)`
:   Flags passed to the linker for shared libraries, such as
    dynamic-link libraries (DLLs).

`$(ldflags-shared-filter <pattern>)`
:   Flags passed to the linker for shared libraries, such as
    dynamic-link libraries (DLLs). Use the *pattern* parameter to
    specify a regular expression that matches the build targets that use
    these flags.

`$(ldflags-static)`
:   Flags passed to the linker for statically-linked libraries.

`$(ldflags-static-filter <pattern>)`
:   Flags passed to the linker for statically-linked libraries. Use the
    *pattern* parameter to specify a regular expression that matches the
    build targets that use these flags.

`$(platform-name)`
:   The platform flavor with which this `cxx_genrule` was specified.

#### Parameterized Macros

It is also possible to expand references to other rules within the shell
command, using the following subset of the builtin {call
buck.string_parameter_macros /}. Note that all build rules expanded in
the command are automatically considered to be dependencies of the
`genrule()`.

{call genrule_common.abs_path_note /}

`$(exe //path/to:target)`
:   Expands to the commands necessary to run the executable generated by
    the specified build rule. For a C++ executable, this will typically
    just be the name of the output executable itself, such as `main`. If
    the specified build rule does not generate an executable output, an
    exception will be thrown and the build will fail.

`$(location //path/to:target)`
:   Expands to the path of the output of the build rule. This means that
    you can refer to these without needing to be aware of how Buck is
    storing data on the disk mid-build.

#### Variables

Finally, Buck adds the following variables to the environment in which
the shell command runs. They are accessed using the following syntax.
Note the use of braces rather than parentheses.

    ${<variable>}

Example:

    ${SRCS}

`${SRCS}`\
:   A string expansion of the `srcs` argument delimited by the
    `environment_expansion_separator` argument where each element of
    `srcs` will be translated into an absolute path.

`${SRCDIR}`\
:   The absolute path to the to which sources are copied prior to
    running the command.

`${OUT}`
:   The output file for the `genrule()`. The file specified by this
    variable must always be written by this command. If not, the
    execution of this rule will be considered a failure, halting the
    build process.

`${TMP}`
:   A temporary directory which can be used for intermediate results and
    will not be bundled into the output.

{/param} {/call} {call genrule_common.bash_arg /} {call
genrule_common.cmd_exe_arg /} {call genrule_common.type_arg /} {call
genrule_common.out_arg /} {call
genrule_common.environment_expansion_separator /} {call buck.arg} {param
name: \'enable_sandbox\' /} {param default : \'False\' /} {param desc}
Whether this target should be executed in a sandbox or not. {/param}
{/call} {call buck.arg} {param name: \'executable\' /} {param default :
\'False\' /} {param desc} Whether the output of the genrule is itself
executable. Marking an output as executable makes `buck run` and
`$(exe ...)` macro expansion work with this target. {/param} {/call}
{call buck.tests_arg /} {/param} // close args {/call} // close
buck.rule {/param} {/call} {/template}
