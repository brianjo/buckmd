/\* \* Copyright (c) Facebook, Inc. and its affiliates. \* \* Licensed
under the Apache License, Version 2.0 (the \"License\"); \* you may not
use this file except in compliance with the License. \* You may obtain a
copy of the License at \* \* http://www.apache.org/licenses/LICENSE-2.0
\* \* Unless required by applicable law or agreed to in writing,
software \* distributed under the License is distributed on an \"AS IS\"
BASIS, \* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
or implied. \* See the License for the specific language governing
permissions and \* limitations under the License. \*/ {namespace
android_binary} /\*\*\*/ {template .soyweb} {call buck.page} {param
title: \'android_binary()\' /} {param navid: \'rule_android_binary\' /}
{param prettify: true /} {param description} A rule that generates an
Android APK. {/param} {param content} {call buck.rule} {param status:
\'FROZEN\' /} {param overview}

An `android_binary()` rule is used to generate an Android APK.

{/param} {param args} {call buck.arg} {param name: \'name\' /} {param
desc} The *short name* for this {call buck.build_target /}. Also, the
name of the APK generated from this target. {/param} {/call} {call
android_common.manifest_apk_arg /} {call buck.arg} {param name:
\'keystore\' /} {param desc} A build target that identifies a {call
buck.keystore /} to use to sign the APK. {/param} {/call} {call
buck.arg} {param name : \'package_type\' /} {param default :
\'\\\'debug\\\'\' /} {param desc} Determines whether ProGuard will be
used when packaging the APK. Acceptable values for `package_type` are
`'debug'` and `'release'`. The default value is `'debug'`, which
indicates that ProGuard should not be used.

// t2272739 **Note:** This argument will be renamed to reflect that it
determines the use of ProGuard. {/param} {/call} {call buck.arg} {param
name : \'proguard_config\' /} {param default : \'None\' /} {param desc}
Relative path to a ProGuard configuration file that will be passed via
the `-include` flag when `package_type` is {sp}`'release'`. {/param}
{/call} {call buck.arg} {param name : \'android_sdk_proguard_config\' /}
{param default : \'\\\'default\\\'\' /} {param desc} The type of
proguard configuration to use from the Android SDK. Options are
`'default'` to use the default config, `'optimized'` to use the config
with optimizations enabled, or `'none'` to not use any standard
configuration (you will need to supply your own version, otherwise your
app will probably not work). {/param} {/call} {call buck.arg} {param
name : \'ignore_aapt_proguard_config\' /} {param default : \'False\' /}
{param desc} If true, the proguard config automatically generated by
`aapt` will be ignored. {/param} {/call} {call buck.arg} {param name :
\'no_dx\' /} {param default : \'\[\]\' /} {param desc} List of build
targets that may have been included during compilation of {sp} the
transitive `android_library()` and{sp} `java_library()` dependencies,
but should not be included{sp} in the `classes.dex` for generated for
the APK. {/param} {/call} {call buck.arg} {param name :
\'build_config_values\' /} {param default : \'\[\]\' /} {param desc} See
the documentation on the values argument for {call
buck.android_build_config /}. {/param} {/call} {call buck.arg} {param
name : \'build_config_values_file\' /} {param default : \'None\' /}
{param desc} See the documentation on the values_file argument for {call
buck.android_build_config /}. {/param} {/call} {call buck.arg} {param
name : \'aapt_mode\' /} {param default : \'aapt1\' /} {param desc} Set
to `"aapt2"` to build resources for this app with aapt2. {/param}
{/call} {call buck.arg} {param name : \'skip_crunch_pngs\' /} {param
default : \'False\' /} {param desc} If `True`, PNGs in the APK are not
crushed by aapt. This is equivalent to specifying {literal}

``` {.prettyprint .lang-js}
  android {
      aaptOptions.useAaptPngCruncher = false
  }
  
```

{/literal} in gradle, or {literal}

``` {.prettyprint .lang-xml}
  <target name="-crunch">
      <echo message="Skipping PNG optimization"/>
  </target>
  
```

{/literal} in ant. This can be useful if the PNGs have been optimised
beforehand, as aapt would attempt to crush the optimised PNGs and end up
increasing their size instead of decreasing it. {/param} {/call} {call
buck.arg} {param name : \'duplicate_resource_behavior\' /} {param
default : \'allow_by_default\' /} {param desc} If set to
`"ban_by_default"`, duplicate resource definitions with the same type
and name will cause the build to fail, unless they are excluded by
`allowed_duplicate_resource_types` or `duplicate_resource_whitelist`. If
set to `"allow_by_default"` (the default), no duplicate resource checks
will be performed. They can still be enabled on individual types by
using `banned_duplicate_resource_types`. {/param} {/call} {call
buck.arg} {param name : \'banned_duplicate_resource_types\' /} {param
default : \'\[\]\' /} {param desc} If `['string']` is used, the build
will break if multiple string resources with the same name are added in
an app\'s Android Resources. Resource names are name-spaced by resource
type, this does not enforce unique names between multiple resource
types. AAPT does not enforce this, but you can prevent easy-to-introduce
resource bugs by enabling this. {/param} {/call} {call buck.arg} {param
name : \'allowed_duplicate_resource_types\' /} {param default : \'\[\]\'
/} {param desc} Similar to `banned_duplicate_resource_types`, but lists
the types that are allowed to have duplicates. This should only be used
if `duplicate_resource_behavior` is `"ban_by_default"`. {/param} {/call}
{call buck.arg} {param name : \'duplicate_resource_whitelist\' /} {param
default : \'None\' /} {param desc} Either a {call buck.build_target /}
or a path to a file containing a whitelist of resources that should be
excluded from duplicate resource detection. Format is one resource per
line with the type followed by the name, separated by a space. For
example, `string app_name`. {/param} {/call} {call buck.arg} {param name
: \'includes_vector_drawables\' /} {param default : \'False\' /} {param
desc} When calling AAPT during the packaging process, pass the
`   --no-version-vectors` flag which ensures that any vector drawables
which make use of the Android support library are backwards compatible
with Android 4.4 and earlier. {/param} {/call} {call buck.arg} {param
name : \'manifest_entries\' /} {{param default : \'{}\' /}} {param desc}
Insert values into the packaged `AndroidManifest.xml` file. Valid values
are `min_sdk_version`, `target_sdk_version`, `version_code`,
`version_name`, and `debug_mode`. Example: {literal}

``` {.prettyprint .lang-py}
  android_binary(
    # ... other args ...
    manifest_entries = {
        'version_code': 12,
        'version_name': '2.0',
        'min_sdk_version': 16,
        'target_sdk_version': 23,
        'debug_mode': True,
    }
  )
  
```

{/literal} This is equivalent to specifying {literal}

``` {.prettyprint .lang-js}
  android {
      defaultConfig {
        versionCode 12
        versionName "2.0"
        minSdkVersion 16
        targetSdkVersion 23
      }
  }
  
```

{/literal} in gradle and building the debug `BuildType`. This is
especially useful when combined with the
[`flatten_dicts`](%7BROOT%7Dfunction/flatten_dicts.html) function. This
will allow you to share a default config across your rules, and override
values as necessary. {/param} {/call} {call android_common.deps_apk_arg
/} {call buck.arg} {param name : \'cpu_filters\' /} {param default :
\'\[\]\' /} {param desc} The CPU architecture filter applied to the
final apk. Could be a subset of `ARM`, {sp}`ARMV7`, `ARM64`, `X86`,
`X86_64`, `MIPS`.

**Note**: If you set this parameter, you must setup your NDK, otherwise
BUCK build will fail. You can follow the Android SDK and NDK part of the
{sp}[install guide](%7BROOT%7Dsetup/install.html) to set it up.

{/param} {/call} {call buck.arg} {param name : \'use_split_dex\' /}
{param default : \'False\' /} {param desc}

If this argument is `True`, Buck enables *multidex* support for the
output APK. Multidex support enables your app to use multiple Dalvik
Executable (DEX) bytecode files and thereby work around the 64K limit on
the number of methods that can be referenced in a single DEX file.

    {literal}
    use_split_dex = True
    {/literal}

For more information on multidex support, go to the [Android Developer
Documentation](https://developer.android.com/studio/build/multidex).

{/param} {/call} {call buck.arg} {param name :
\'application_module_configs\' /} {param default : \'\[\]\' /} {param
desc}

A map of module names to lists of targets, where the targets should
*seed* the corresponding module. The seed targets and their exclusive
dependencies are packaged into the APK in separate files to allow them
to be loaded independently.

{/param} {/call} {call buck.arg} {param name :
\'linear_alloc_hard_limit\' /} {param default : \'4194304\' /} {param
desc} The size at which secondary dex files should be split when
building an {sp}[exopackage](%7BROOT%7Darticle/exopackage.html) in
bytes.

It is set 4MB by default, because Android 2.3 has a LinearAlloc limit of
5MB and 1MB is taken up by the framework. More recent versions of
Android have a LinearAlloc limit of 8MB or 16MB, so if the APK is only
targeted for versions newer than 2.3, a 7MB limit is safe to use.

{/param} {/call} {call buck.arg} {param name : \'skip_proguard\' /}
{param default : \'False\' /} {param desc} To produce a release build
without running ProGuard set the `skip_proguard` flag to `True`. This
will still cause ProGuard configuration files to be generated for use by
other optimizers like Redex. {/param} {/call} {call buck.arg} {param
name : \'redex\' /} {param default : \'False\' /} {param desc}

Set this to `True` to run ReDex on the APK generated by this rule.

{call .redexLink /} {/param} {/call} {call buck.arg} {param name :
\'redex_config\' /} {param default : \'None\' /} {param desc}

Path to a ReDex config file. (This is passed as via the `--config`
option to ReDex.) Note this may be a generated file.

{call .redexLink /} {/param} {/call} {call buck.arg} {param name :
\'redex_extra_args\' /} {param default : \'\[\]\' /} {param desc}

A list of additional arguments to pass to the ReDex binary.

{call .redexLink /} {/param} {/call} {call buck.arg} {param name :
\'native_library_merge_map\' /} {{param default : \'{}\' /}} {param
desc}

An advanced option for apps with many native libraries. For more
details, see [this
article](https://github.com/fbsamples/android-native-library-merging-demo).

{/param} {/call} {/param} // close args {param examples} Here is an
example of an `android_binary()` rule that includes Android resources
from one dependency and compiled Java code from another dependency:
{literal}

``` {.prettyprint .lang-py}
android_resource(
  name = 'res',
  res = 'res',
  assets = 'assets',
)

android_library(
  name = 'src',
  srcs = glob(['src/**/*.java']),
  deps = [
    ':res',
  ],
)

# Building this rule will produce a file named messenger.apk.
android_binary(
  name = 'messenger',
  manifest = 'AndroidManifest.xml',
  keystore = '//keystores:prod',
  package_type = 'release',
  proguard_config = 'proguard.cfg',
  deps = [
    ':res',
    ':src',
  ],
)
```

{/literal}

## ReDex {#redex-overview}

Buck makes it easy to run [ReDex](http://fbredex.com/) as part of
`android_binary()`. ReDex is an Android bytecode optimizer that can help
reduce the size of your release builds. Please refer to
[ReDex](http://fbredex.com/) for instructions on how to create a ReDex
executable.

Currently, the path to ReDex must be specified as a path (or build
target) in `.buckconfig`:

{literal}

``` {.prettyprint .lang-ini}
[android]
  # In this example, we assume that you have ReDex packaged as a single
  # executable file named redex-bin. Read "Creating redex-bin" below on how
  # to create this file. Note that the expectation is that you check
  # redex-bin into your project.
  redex = third-party/native/redex/redex-bin

  # Alternatively, you could create a genrule(), such as
  # //tools/redex:redex, that wraps ReDex. It must have
  # `executable = True` to ensure the genrule() is runnable.
  # In this case, you would specify the build target instead
  # of the file path.
  # redex = //tools/redex:redex
```

{/literal}

If a ReDex executable is set properly in `.buckconfig`, then it is
possible to run ReDex as part of building an `android_binary()`, but the
following conditions must hold:

-   `redex = True` must be set on the `android_binary()`.

Other ReDex configuration options on `android_binary()` include:

-   `redex_config`
-   `redex_json_args`

{/param} {/call} // close buck.rule

## Fast DEX merging for Android

Buck includes a customized version of the Android DEX compiler, `dx`,
which includes significant performance improvements. It uses a faster
algorithm for merging many DEX files, which is especially effective
because of Buck\'s support for fine-grained libraries.

The custom version of `dx` also supports running multiple copies of `dx`
concurrently within a single long-lived `buckd` process, which
eliminates most of `dx's` start-up time.

{/param} {/call} {/template} /\*\*\*/ {template .redexLink} {/template}
