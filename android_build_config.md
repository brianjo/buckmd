/\* \* Copyright (c) Facebook, Inc. and its affiliates. \* \* Licensed
under the Apache License, Version 2.0 (the \"License\"); \* you may not
use this file except in compliance with the License. \* You may obtain a
copy of the License at \* \* http://www.apache.org/licenses/LICENSE-2.0
\* \* Unless required by applicable law or agreed to in writing,
software \* distributed under the License is distributed on an \"AS IS\"
BASIS, \* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
or implied. \* See the License for the specific language governing
permissions and \* limitations under the License. \*/ {namespace
android_build_config} /\*\*\*/ {template .soyweb} {call buck.page}
{param title: \'android_build_config()\' /} {param navid:
\'rule_android_build_config\' /} {param prettify: true /} {param
description} A rule that is used to generate a BuildConfig class with
global configuration variables that android_library() rules can compile
against. {/param} {param content} {call buck.rule} {param status:
\'UNFROZEN\' /} {param overview} An `android_build_config()` rule is
used to generate a `BuildConfig` class with global configuration
variables that other {call buck.android_library /} rules can compile
against. Currently, the only variable exposed by `BuildConfig` is a
global `boolean` named `DEBUG`, much like the `BuildConfig.java`
generated by the official Android build tools based on Gradle.

The fields in the generated `BuildConfig` class will be
non-constant-expressions (see{sp} [JLS
15.28](http://docs.oracle.com/javase/specs/jls/se7/html/jls-15.html#jls-15.28)).
However, if `BuildConfig` is packaged into an APK, it will be replaced
with a new version where:

-   The fields will be set to literal values (i.e., constant
    expressions).
-   The `boolean BuildConfig.DEBUG` field will correspond to that of the
    `package_type` argument to the {call buck.android_binary /} rule
    that is packaging it.

This transformation is done before ProGuard is applied (if applicable),
so that it can propagate constants from `BuildConfig` and eliminate dead
code. {/param} {param args} {call buck.name_arg /} {call buck.arg}
{param name: \'package\' /} {param desc} Name of the Java package to use
in the generated `BuildConfig.java` file. Most developers set this to
the application id declared in the manifest via
`<manifest package="APP_ID">`. Example: `com.facebook.orca`. {/param}
{/call} {call buck.arg} {param name: \'values\' /} {param default :
\'\[\]\' /} {param desc}

List of strings that defines additional fields (and values) that should
be declared in the generated `BuildConfig.java` file. Like `DEBUG`, the
values will be non-constant-expressions that evaluate to the value
specified in the file at compilation time. To override the values in an
APK, specify build_config_values{sp}or{sp} build_config_values_file in
{call buck.android_binary /}. {/param} {/call} {call buck.arg} {param
name: \'values_file\' /} {param default : \'None\' /} {param desc}

Optional path to a file that defines additional fields (and values) that
should be declared in the generated `BuildConfig.java` file. Like
`DEBUG`, the values will be non-constant-expressions that evaluate to
the value specified in the file at compilation time. To override the
values in an APK, specify build_config_values{sp}or{sp}
build_config_values_file in {call buck.android_binary /}.

Note that values_file can be a generated file, as can
build_config_values_file as demonstrated in the example below. {/param}
{/call} /\* Technically, the deps argument exists, but there is no use
for it yet. {call buck.arg} {param name : \'deps\' /} {param default :
\'\[\]\' /} {param desc} {/call} \*/ {/param} // close args {param
examples}

Here is an example of an `android_build_config()` rule that is
transitively included by both *debug* and *release* versions of an {call
buck.android_binary /} rule. The value of
`com.example.pkg.BuildConfig.DEBUG` will be different in each APK even
though they both transitively depend on the same `:build_config` rule.
{literal}

``` {.prettyprint .lang-py}
android_build_config(
  name = 'build_config',
  package = 'com.example.pkg',
  values = [
    'String COMMIT_ID = "0000000000000000000000000000000000000000"',
  ],
)

# The .java files in this library may contain references to the boolean
# com.example.pkg.BuildConfig.DEBUG because :build_config is in the deps.
# It could also reference BuildConfig.COMMIT_ID.
android_library(
  name = 'mylib',
  srcs = glob(['src/**/*.java']),
  deps = [
    ':build_config',
  ],
)

android_binary(
  name = 'debug',
  package_type = 'DEBUG',
  keystore =  '//keystores:debug',
  manifest = 'AndroidManifest.xml',
  target = 'Google Inc.:Google APIs:19',
  deps = [
    ':mylib',
  ],
)

# The contents of the file generated by this rule might be:
#
# String COMMIT_ID = "7bf804bdf71fdbfc99cce3b155b3643f022c6fa4"
#
# Note that the output of :build_config_release_values will be cached by Buck.
# Assuming that generate_release_build_config.py depends on state that is not
# expressed by its deps (which violates a fundamental invariant in Buck!), a
# workaround is to ensure that the inputs to :build_config_release_values are
# changed in some way before :release is built to ensure that the output from
# :build_config_release_values is not pulled from cache. For example:
#
# $ buck build :release
# $ uuidgen > dummy_state_file.txt
# $ buck build :release
#
# This makes sure that generate_release_build_config.py is re-run before
# :release is rebuilt. This is much cheaper than deleting your build cache
# before rebuilding.
genrule(
  name = 'build_config_release_values',
  srcs = [ 'generate_release_build_config.py', 'dummy_state_file.txt' ],
  bash = 'generate_release_build_config.py $OUT',
  out = 'build_config_release_values.txt',
)

android_binary(
  name = 'release',
  package_type = 'RELEASE',
  keystore =  '//keystores:release',
  manifest = 'AndroidManifest.xml',
  target = 'Google Inc.:Google APIs:19',
  build_config_values_file = ':build_config_release_values',
  deps = [
    ':mylib',
  ],
)
```

{/literal} {/param} {/call} // close buck.rule {/param} {/call}
{/template}
